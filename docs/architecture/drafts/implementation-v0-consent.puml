@startuml
skinparam nodesep 10
skinparam ranksep 10
skinparam swimlane {
  BorderThickness 2
  TitleFontColor black
  TitleFontSize 20
  width 30
}

|PSU|
start
-> FinTech,\nplease analyze my Tx's\n(happens from unspecified location);
|FinTech with OpenBankingGw API|
-> Grant AIS consent - call\n**PUT /grant/AIS/{bankId}**;
:{{
database "Dynamic KB\n(i.e. client ip address)" as DKB
component "FinTech KB adapter" as FKBA
DKB ==> FKBA
}};
-> Grant AIS consent - call\n**PUT /grant/AIS/{bankId}**\nwith knowledge context;
|#AntiqueWhite|TPP with OpenBankingGw Impl|
:{{
database "Static KB\n(i.e. bank profile)" as SKB
database "Dynamic KB\n(i.e. FinTech\nphysical address)" as DKB
component "<size:30><&spreadsheet></size>Request context knowledge" as knowledge
DKB ==> knowledge
SKB ==> knowledge
}};
:{{
component "<size:30><&cog></size> Request validation engine\n(mock that validates if\nall params are present)" as mockEngine
component "<size:30><&fork></size>ASPSP mock endpoints with\nrequest definition" as ASPSPMock
mockEngine <=left=> ASPSPMock : Mock requests
}};
|BPMN Engine inside TPP|
:{{
skinparam nodesep 10
skinparam ranksep 10
header
<font color=red>Same flow as below (Consent creation)</font>
endheader
AIS -> "(MOCK) ASPSP" ++ : Consent creation request
return Consent creation response
AIS -> "(MOCK) ASPSP" ++ : Consent status request
return Consent status response
}};
|TPP with OpenBankingGw Impl|
if (<size:14>Not all required parameters</size>\n<size:14>are present?</size>) then (YES)
|FinTech with OpenBankingGw API|
:Handle not all parameters are available;
stop
else (NO - ALL PRESENT)
|TPP with OpenBankingGw Impl|
:{{
component "<size:30><&cog></size>Request performing engine (<b><&cog>RPE</b>)" as engine
}};
endif
|#AntiqueWhite|BPMN Engine inside TPP|
:{{
skinparam nodesep 10
skinparam ranksep 10
header
<font color=red>Consent creation</font>
endheader
AIS -> ASPSP ++ : Create consent request
return Create consent response
AIS -> PSU : Authorize consent
loop SCA Authorization
ASPSP -> PSU : SCA challenge
PSU -> ASPSP : Challenge result
end
}};
-> Call sequence to declare consent on behalf of <b>TPP</b>;
|ASPSP|
:Create consent;
note right
  Generated by <&cog>RPE
end note
:Authorize consent;
note right
  Generated by <&cog>RPE
end note
|PSU|
:Complete SCA challenge;
|ASPSP|
:Confirmed;
note right
  Generated by <&cog>RPE
end note
|TPP with OpenBankingGw Impl|
:Confirmed;
|FinTech with OpenBankingGw API|
:Confirmed;
stop
@enduml